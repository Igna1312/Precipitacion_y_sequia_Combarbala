[
  {
    "objectID": "spei.html",
    "href": "spei.html",
    "title": "Código de análisis de Precipitación",
    "section": "",
    "text": "Cargamos las librerías necesarias y definimos las rutas de los 6 archivos crudos (Precipitación, T.Máx y T.Mín para cada estación).\n\n\nCódigo\n# Limpiar memoria\nrm(list = ls())\n\n# 1. Cargar paquetes\nif (!require(\"pacman\")) install.packages(\"pacman\")\n# Agregamos 'gridExtra' y 'grid' para poder guardar tablas como imágenes\npacman::p_load(tidyverse, SPEI, lubridate, fs, here, knitr, gridExtra, grid)\n\n# 2. Definir Rutas de Datos Crudos\nruta_ram_pp   &lt;- here::here(\"data\", \"data_raw\", \"ramadas_pmen.csv\")\nruta_ram_tmax &lt;- here::here(\"data\", \"data_raw\", \"ramadas_tmax.csv\")\nruta_ram_tmin &lt;- here::here(\"data\", \"data_raw\", \"ramadas_tmin.csv\")\n\nruta_cog_pp   &lt;- here::here(\"data\", \"data_raw\", \"cogoti_pmen.csv\")\nruta_cog_tmax &lt;- here::here(\"data\", \"data_raw\", \"cogoti_tmax.csv\")\nruta_cog_tmin &lt;- here::here(\"data\", \"data_raw\", \"cogoti_tmin.csv\")\n\n# Rutas de Salida\ndir_figuras   &lt;- here::here(\"figuras\")\ndir_data_proc &lt;- here::here(\"data\", \"data_procesada\")\n\n# 3. Verificación rápida\narchivos_requeridos &lt;- c(ruta_ram_pp, ruta_ram_tmax, ruta_ram_tmin, \n                         ruta_cog_pp, ruta_cog_tmax, ruta_cog_tmin)\n\nif (!all(file.exists(archivos_requeridos))) {\n  faltantes &lt;- archivos_requeridos[!file.exists(archivos_requeridos)]\n  stop(\"ERROR: Faltan archivos en data/data_raw/:\\n\", paste(faltantes, collapse = \"\\n\"))\n}\n\n# Crear carpetas de salida\nif (!dir.exists(dir_figuras)) dir.create(dir_figuras, recursive = TRUE)\nif (!dir.exists(dir_data_proc)) dir.create(dir_data_proc, recursive = TRUE)\n\nmessage(\"Configuración exitosa. Archivos encontrados.\")"
  },
  {
    "objectID": "spei.html#configuración-inicial",
    "href": "spei.html#configuración-inicial",
    "title": "Código de análisis de Precipitación",
    "section": "",
    "text": "Cargamos las librerías necesarias y definimos las rutas de los 6 archivos crudos (Precipitación, T.Máx y T.Mín para cada estación).\n\n\nCódigo\n# Limpiar memoria\nrm(list = ls())\n\n# 1. Cargar paquetes\nif (!require(\"pacman\")) install.packages(\"pacman\")\n# Agregamos 'gridExtra' y 'grid' para poder guardar tablas como imágenes\npacman::p_load(tidyverse, SPEI, lubridate, fs, here, knitr, gridExtra, grid)\n\n# 2. Definir Rutas de Datos Crudos\nruta_ram_pp   &lt;- here::here(\"data\", \"data_raw\", \"ramadas_pmen.csv\")\nruta_ram_tmax &lt;- here::here(\"data\", \"data_raw\", \"ramadas_tmax.csv\")\nruta_ram_tmin &lt;- here::here(\"data\", \"data_raw\", \"ramadas_tmin.csv\")\n\nruta_cog_pp   &lt;- here::here(\"data\", \"data_raw\", \"cogoti_pmen.csv\")\nruta_cog_tmax &lt;- here::here(\"data\", \"data_raw\", \"cogoti_tmax.csv\")\nruta_cog_tmin &lt;- here::here(\"data\", \"data_raw\", \"cogoti_tmin.csv\")\n\n# Rutas de Salida\ndir_figuras   &lt;- here::here(\"figuras\")\ndir_data_proc &lt;- here::here(\"data\", \"data_procesada\")\n\n# 3. Verificación rápida\narchivos_requeridos &lt;- c(ruta_ram_pp, ruta_ram_tmax, ruta_ram_tmin, \n                         ruta_cog_pp, ruta_cog_tmax, ruta_cog_tmin)\n\nif (!all(file.exists(archivos_requeridos))) {\n  faltantes &lt;- archivos_requeridos[!file.exists(archivos_requeridos)]\n  stop(\"ERROR: Faltan archivos en data/data_raw/:\\n\", paste(faltantes, collapse = \"\\n\"))\n}\n\n# Crear carpetas de salida\nif (!dir.exists(dir_figuras)) dir.create(dir_figuras, recursive = TRUE)\nif (!dir.exists(dir_data_proc)) dir.create(dir_data_proc, recursive = TRUE)\n\nmessage(\"Configuración exitosa. Archivos encontrados.\")"
  },
  {
    "objectID": "spei.html#procesamiento-de-datos",
    "href": "spei.html#procesamiento-de-datos",
    "title": "Código de análisis de Precipitación",
    "section": "2. Procesamiento de datos",
    "text": "2. Procesamiento de datos\nEn esta etapa leemos los archivos individuales de temperatura y precipitación, los unimos por año y mes, y calculamos el balance hídrico.\n\n\nCódigo\n# Función auxiliar para leer\nleer_variable &lt;- function(ruta, nombre_var) {\n  read_csv(ruta, show_col_types = FALSE) %&gt;%\n    select(agno, mes, valor) %&gt;%\n    rename(!!nombre_var := valor)\n}\n\n# --- PROCESAMIENTO LAS RAMADAS ---\nram_pp   &lt;- leer_variable(ruta_ram_pp, \"pmen\")\nram_tmax &lt;- leer_variable(ruta_ram_tmax, \"tmax\")\nram_tmin &lt;- leer_variable(ruta_ram_tmin, \"tmin\")\n\n# Unimos por año y mes\ndf_ramadas &lt;- list(ram_pp, ram_tmax, ram_tmin) %&gt;%\n  reduce(full_join, by = c(\"agno\", \"mes\")) %&gt;%\n  mutate(estacion = \"Las Ramadas\")\n\n# --- PROCESAMIENTO COGOTÍ ---\ncog_pp   &lt;- leer_variable(ruta_cog_pp, \"pmen\")\ncog_tmax &lt;- leer_variable(ruta_cog_tmax, \"tmax\")\ncog_tmin &lt;- leer_variable(ruta_cog_tmin, \"tmin\")\n\ndf_cogoti &lt;- list(cog_pp, cog_tmax, cog_tmin) %&gt;%\n  reduce(full_join, by = c(\"agno\", \"mes\")) %&gt;%\n  mutate(estacion = \"Cogotí\")\n\n# --- UNIFICACIÓN Y CÁLCULOS ---\ndatos &lt;- bind_rows(df_ramadas, df_cogoti) %&gt;%\n  mutate(fecha = make_date(agno, mes, 1)) %&gt;%\n  # Eliminamos filas sin temperatura ANTES de calcular hargreaves\n  drop_na(tmax, tmin) %&gt;%\n  mutate(\n    # Ahora sí podemos calcular ETP sin errores\n    etp = hargreaves(tmin, tmax, lat = -31.0358),\n    bal = pmen - etp\n  ) %&gt;%\n  # Limpiamos si falta precipitación o balance final\n  drop_na(bal) %&gt;%\n  arrange(estacion, fecha)\n\n\n[1] \"Calculating reference evapotranspiration using the Hargreaves method. Using latitude (`lat`) to estimate extraterrestrial radiation. Checking for missing values (`NA`): all the data must be complete. Input type is vector. Assuming the data are monthly time series starting in January, all regular (non-leap) years.\"\n\n\nCódigo\n# Guardar CSV procesado\nwrite_csv(datos, path(dir_data_proc, \"datos_procesados_unificados.csv\"))\n\n# --- CÁLCULO DE SPEI ---\ndatos_spei &lt;- datos %&gt;%\n  group_by(estacion) %&gt;%\n  nest() %&gt;%\n  mutate(\n    spei_12 = map(data, ~ as.numeric(spei(.x$bal, 12)$fitted)),\n    spei_03 = map(data, ~ as.numeric(spei(.x$bal, 3)$fitted))\n  ) %&gt;%\n  unnest(cols = c(data, spei_12, spei_03)) %&gt;% \n  ungroup()\n\n\n[1] \"Calculating the Standardized Precipitation Evapotranspiration Index (SPEI) at a time scale of 12. Using kernel type 'rectangular', with 0 shift. Fitting the data to a log-Logistic distribution. Using the ub-pwm parameter fitting method. Checking for missing values (`NA`): all the data must be complete. Using the whole time series as reference period. Input type is vector. No time information provided, assuming a monthly time series.\"\n[1] \"Calculating the Standardized Precipitation Evapotranspiration Index (SPEI) at a time scale of 12. Using kernel type 'rectangular', with 0 shift. Fitting the data to a log-Logistic distribution. Using the ub-pwm parameter fitting method. Checking for missing values (`NA`): all the data must be complete. Using the whole time series as reference period. Input type is vector. No time information provided, assuming a monthly time series.\"\n[1] \"Calculating the Standardized Precipitation Evapotranspiration Index (SPEI) at a time scale of 3. Using kernel type 'rectangular', with 0 shift. Fitting the data to a log-Logistic distribution. Using the ub-pwm parameter fitting method. Checking for missing values (`NA`): all the data must be complete. Using the whole time series as reference period. Input type is vector. No time information provided, assuming a monthly time series.\"\n[1] \"Calculating the Standardized Precipitation Evapotranspiration Index (SPEI) at a time scale of 3. Using kernel type 'rectangular', with 0 shift. Fitting the data to a log-Logistic distribution. Using the ub-pwm parameter fitting method. Checking for missing values (`NA`): all the data must be complete. Using the whole time series as reference period. Input type is vector. No time information provided, assuming a monthly time series.\"\n\n\nCódigo\nglimpse(datos_spei)\n\n\nRows: 1,165\nColumns: 11\n$ estacion &lt;chr&gt; \"Cogotí\", \"Cogotí\", \"Cogotí\", \"Cogotí\", \"Cogotí\", \"Cogotí\", \"…\n$ agno     &lt;dbl&gt; 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1…\n$ mes      &lt;dbl&gt; 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9…\n$ pmen     &lt;dbl&gt; 0.0, 0.0, 2.0, 38.0, 2.4, 153.5, 161.5, 0.0, 0.0, 1.2, 0.0, 0…\n$ tmax     &lt;dbl&gt; 28.9, 25.9, 23.3, 21.4, 21.9, 17.0, 16.0, 19.4, 22.8, 24.6, 2…\n$ tmin     &lt;dbl&gt; 16.3, 13.7, 11.3, 8.4, 8.4, 5.8, 6.0, 6.9, 9.4, 11.3, 14.0, 1…\n$ fecha    &lt;date&gt; 1965-02-01, 1965-03-01, 1965-04-01, 1965-05-01, 1965-06-01, …\n$ etp      &lt;dbl&gt; 169.68881, 168.07156, 152.84507, 122.46746, 119.65757, 73.512…\n$ bal      &lt;dbl&gt; -169.68881, -168.07156, -150.84507, -84.46746, -117.25757, 79…\n$ spei_12  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 1.3954235, 1.3959…\n$ spei_03  &lt;dbl&gt; NA, NA, -0.07306118, 0.24514050, -0.38907950, 0.88506499, 1.5…"
  },
  {
    "objectID": "spei.html#visualización-de-precipitación-mensual",
    "href": "spei.html#visualización-de-precipitación-mensual",
    "title": "Código de análisis de Precipitación",
    "section": "3. Visualización de precipitación mensual",
    "text": "3. Visualización de precipitación mensual\nAnálisis de la distribución de lluvias para ambas estaciones (1970-2015).\n\n\nCódigo\n# 1. Identificar estaciones únicas\nestaciones_lista &lt;- unique(datos_spei$estacion)\n\n# 2. Definir función para graficar y guardar\ngenerar_boxplot &lt;- function(nombre_estacion) {\n  \n  # Filtrar datos por estación y fecha\n  df_box &lt;- datos_spei %&gt;% \n    filter(estacion == nombre_estacion, year(fecha) &gt;= 1970 & year(fecha) &lt;= 2015)\n  \n  # Calcular estadísticas para colores\n  medianas &lt;- tapply(df_box$pmen, df_box$mes, median, na.rm=TRUE)\n  paleta   &lt;- colorRampPalette(c(\"#E0F3DB\", \"#084081\"))(100)\n  \n  # Evitar error si todos los valores son iguales\n  if(min(medianas) == max(medianas)) {\n    colores &lt;- rep(paleta[1], 12)\n  } else {\n    colores &lt;- paleta[findInterval(medianas, seq(min(medianas), max(medianas), length.out = 100))]\n  }\n  \n  meses_esp &lt;- c(\"Ene\", \"Feb\", \"Mar\", \"Abr\", \"May\", \"Jun\", \"Jul\", \"Ago\", \"Sep\", \"Oct\", \"Nov\", \"Dic\")\n  \n  # Función interna de dibujo\n  dibujar &lt;- function() {\n    par(mar = c(4, 5, 3, 1))\n    boxplot(pmen ~ factor(mes, levels=1:12, labels = meses_esp), data = df_box,\n            col = colores, outline = FALSE, \n            main = paste(\"Precipitación Mensual en\", nombre_estacion, \"(1970-2015)\"),\n            ylab = \"Precipitación acumulada mensual (mm)\", \n            xlab = \"\", # Eliminamos etiqueta por defecto\n            xaxt = \"n\", # Apagamos eje automático\n            las = 1, varwidth = TRUE)\n            \n    # Dibujamos eje X manual para asegurar que salgan todos los meses\n    axis(1, at = 1:12, labels = meses_esp, las = 1, cex.axis = 0.9)\n    \n    grid(nx = NA, ny = NULL, lty = 3)\n    legend(\"topright\", legend=c(\"Alta precipitación\",\"Baja precipitación\"), fill=c(paleta[100], paleta[1]), bty=\"n\", cex=0.8)\n  }\n  \n  # A. Mostrar en el documento HTML\n  dibujar()\n  \n  # B. Guardar como PNG\n  # Limpiar nombre (Ej: \"Las Ramadas\" -&gt; \"las_ramadas\")\n  nombre_limpio &lt;- tolower(gsub(\" \", \"_\", nombre_estacion)) \n  # Eliminar acentos para el nombre del archivo\n  nombre_limpio &lt;- iconv(nombre_limpio, to=\"ASCII//TRANSLIT\")\n  \n  nombre_archivo &lt;- paste0(\"boxplot_\", nombre_limpio, \".png\")\n  \n  png(path(dir_figuras, nombre_archivo), width = 800, height = 500)\n  dibujar()\n  dev.off()\n}\n\n# 3. Iterar la función sobre la estacion Cogotí usando purrr::walk\nwalk(estaciones_lista, generar_boxplot)\n\n\n\n\n\n\n\n\nFigura 1: Distribución de precipitación mensual (1970-2015)\n\n\n\n\n\n\n\n\n\n\n\nFigura 2: Distribución de precipitación mensual (1970-2015)"
  },
  {
    "objectID": "spei.html#visualización-índice-spei",
    "href": "spei.html#visualización-índice-spei",
    "title": "Código de análisis de Precipitación",
    "section": "4. Visualización: Índice SPEI",
    "text": "4. Visualización: Índice SPEI\nEvolución histórica de las sequías (SPEI-12 y SPEI-3).\n\n\nCódigo\ndatos_grafico &lt;- datos_spei %&gt;% \n  filter(year(fecha) &gt;= 1970 & year(fecha) &lt;= 2015)\n\nplot_spei &lt;- function(df, var_spei, titulo) {\n  ggplot(df, aes(x = fecha, y = .data[[var_spei]])) +\n    geom_hline(yintercept = c(1.5, 2, -1.5, -2), linetype = \"dashed\", color = \"gray60\", alpha = 0.5) +\n    geom_hline(yintercept = 0, color = \"grey40\", linewidth = 0.4) +\n    \n    geom_col(aes(fill = .data[[var_spei]] &gt;= 0), width = 30) +\n    \n    facet_wrap(~ estacion, ncol = 1, scales = \"free_x\") +\n    \n    scale_fill_manual(\n      values = c(\"TRUE\" = \"#6a994e\", \"FALSE\" = \"darkred\"), \n      labels = c(\"TRUE\" = \"Periodos Húmedos\", \"FALSE\" = \"Periodos Secos\"),\n      name = NULL,\n      na.translate = FALSE \n    ) +\n    \n    # Eje Y con enteros forzados\n    scale_y_continuous(breaks = seq(-10, 10, 1)) +\n    \n    labs(title = titulo, x = \"Año\", y = \"SPEI\") +\n    theme_minimal(base_size = 13) +\n    theme(\n      plot.title = element_text(hjust = 0.5, face = \"bold\"), \n      strip.text = element_text(face=\"bold\"),\n      legend.position = \"top\", \n      legend.justification = \"right\",\n      legend.box.margin = margin(0, 0, -5, 0)\n    )\n}\n\ng12 &lt;- plot_spei(datos_grafico, \"spei_12\", \"SPEI 12 Meses (1970-2015)\")\ng03 &lt;- plot_spei(datos_grafico, \"spei_03\", \"SPEI 3 Meses (1970-2015)\")\n\nprint(g12)\nprint(g03)\n\nggsave(path(dir_figuras, \"spei_12.png\"), g12, width = 10, height = 6, dpi = 300)\nggsave(path(dir_figuras, \"spei_03.png\"), g03, width = 10, height = 6, dpi = 300)\n\n\n\n\n\n\n\n\nFigura 3: Evolución del índice SPEI a 12 y 3 meses\n\n\n\n\n\n\n\n\n\n\n\nFigura 4: Evolución del índice SPEI a 12 y 3 meses"
  }
]